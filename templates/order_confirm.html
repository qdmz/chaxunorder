{% extends "base.html" %}

{% block title %}订购产品 - {{ config.SITE_NAME or '产品查询系统' }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('search') }}">产品查询</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('product_detail', product_id=product.id) }}">{{ product.name }}</a></li>
                <li class="breadcrumb-item active">订购产品</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-box-seam"></i> 产品信息</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        {% if product.image_filename %}
                        <img src="{{ url_for('uploaded_file', filename=product.image_filename) }}" 
                             class="img-fluid rounded" 
                             alt="{{ product.name }}"
                             style="max-height: 150px; width: 100%; object-fit: cover;">
                        {% else %}
                        <div class="text-center py-4 bg-light rounded">
                            <i class="bi bi-image" style="font-size: 2rem; color: #6c757d;"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-8">
                        <h6>{{ product.name }}</h6>
                        <p class="text-muted mb-1">货号: {{ product.sku }}</p>
                        {% if product.barcode %}
                        <p class="text-muted mb-1">条码: {{ product.barcode }}</p>
                        {% endif %}
                        {% if product.spec %}
                        <p class="text-muted mb-1">规格: {{ product.spec }}</p>
                        {% endif %}
                        <div class="mt-2">
                            <span class="badge bg-danger">零售: ¥{{ "%.2f"|format(product.retail_price or 0) }}</span>
                            <span class="badge bg-success">批发: ¥{{ "%.2f"|format(product.wholesale_price or 0) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-cart-plus"></i> 订单信息</h5>
            </div>
            <div class="card-body">
                {% if order %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> 订单已成功生成！
                </div>
                
                <table class="table table-borderless">
                    <tr>
                        <td><strong>订单编号:</strong></td>
                        <td>#{{ order.id }}</td>
                    </tr>
                    <tr>
                        <td><strong>产品名称:</strong></td>
                        <td>{{ product.name }}</td>
                    </tr>
                    <tr>
                        <td><strong>订购数量:</strong></td>
                        <td>{{ order.quantity }} 件</td>
                    </tr>
                    <tr>
                        <td><strong>单价:</strong></td>
                        <td>¥{{ "%.2f"|format(order.total_amount / order.quantity) }}</td>
                    </tr>
                    <tr>
                        <td><strong>总金额:</strong></td>
                        <td><span class="text-danger fs-5">¥{{ "%.2f"|format(order.total_amount) }}</span></td>
                    </tr>
                    <tr>
                        <td><strong>客户姓名:</strong></td>
                        <td>{{ order.customer_name }}</td>
                    </tr>
                    <tr>
                        <td><strong>联系电话:</strong></td>
                        <td>{{ order.customer_phone }}</td>
                    </tr>
                    <tr>
                        <td><strong>下单时间:</strong></td>
                        <td>{{ order.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    </tr>
                    <tr>
                        <td><strong>订单状态:</strong></td>
                        <td><span class="order-status status-pending">待确认</span></td>
                    </tr>
                </table>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 我们已收到您的订单，销售人员将尽快与您联系确认。
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="window.print()">
                        <i class="bi bi-printer"></i> 打印订单
                    </button>
                    <a href="{{ url_for('search') }}" class="btn btn-primary">
                        <i class="bi bi-search"></i> 继续购物
                    </a>
                </div>
                
                {% else %}
                <form method="post" id="orderForm">
                    {{ form.hidden_tag() if form.csrf_token else '' }}
                    
                    <div class="mb-3">
                        <label for="quantity" class="form-label">订购数量 <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button" onclick="changeQuantity(-1)">-</button>
                            <input type="number" class="form-control text-center" id="quantity" name="quantity" 
                                   value="1" min="1" max="{{ product.stock_quantity or 999 }}" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="changeQuantity(1)">+</button>
                        </div>
                        {% if product.stock_quantity is defined and product.stock_quantity <= 10 %}
                        <small class="text-warning">当前库存仅剩 {{ product.stock_quantity }} 件</small>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="customer_name" class="form-label">客户姓名 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="customer_name" name="customer_name" 
                               placeholder="请输入您的姓名" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="customer_phone" class="form-label">联系电话 <span class="text-danger">*</span></label>
                        <input type="tel" class="form-control" id="customer_phone" name="customer_phone" 
                               placeholder="请输入11位手机号" pattern="1[3-9]\d{9}" maxlength="11" required>
                        <div class="form-text">请输入有效的手机号码，用于订单确认</div>
                    </div>
                    
                    {% if form.notes %}
                    <div class="mb-3">
                        <label for="notes" class="form-label">备注信息</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" 
                                  placeholder="如有特殊要求请在此说明"></textarea>
                    </div>
                    {% endif %}
                    
                    <div class="alert alert-light">
                        <h6>价格说明:</h6>
                        <p class="mb-1">• 零售价: <span class="text-danger">¥{{ "%.2f"|format(product.retail_price or 0) }}</span> / 件</p>
                        <p class="mb-1">• 批发价: <span class="text-success">¥{{ "%.2f"|format(product.wholesale_price or 0) }}</span> / 件 (10件起)</p>
                        <p class="mb-0"><small>批量订购享受批发价格优惠</small></p>
                    </div>
                    
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5>预估总金额</h5>
                            <h3 id="totalAmount">¥{{ "%.2f"|format(product.retail_price or 0) }}</h3>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-3">
                        <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                            <i class="bi bi-cart-check"></i> 提交订单
                        </button>
                        <a href="{{ url_for('product_detail', product_id=product.id) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> 返回产品详情
                        </a>
                    </div>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-shield-check"></i> 订购须知</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-clock-history"></i> 处理时间</h6>
                        <ul>
                            <li>订单提交后，我们会在1个工作日内与您联系确认</li>
                            <li>确认后1-3个工作日内发货</li>
                            <li>特殊情况下可能延迟，我们会及时通知</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-exclamation-triangle"></i> 注意事项</h6>
                        <ul>
                            <li>请确保联系方式准确，以便我们及时联系</li>
                            <li>产品价格如有变动，以实际确认为准</li>
                            <li>如有疑问，欢迎随时联系我们</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let retailPrice = {{ product.retail_price or 0 }};
    let wholesalePrice = {{ product.wholesale_price or 0 }};
    let wholesaleThreshold = 10;
    
    function changeQuantity(delta) {
        const quantityInput = document.getElementById('quantity');
        let currentValue = parseInt(quantityInput.value) || 1;
        let newValue = currentValue + delta;
        let maxValue = parseInt(quantityInput.max) || 999;
        
        newValue = Math.max(1, Math.min(newValue, maxValue));
        quantityInput.value = newValue;
        updateTotalAmount();
    }
    
    function updateTotalAmount() {
        const quantity = parseInt(document.getElementById('quantity').value) || 1;
        const unitPrice = quantity >= wholesaleThreshold ? wholesalePrice : retailPrice;
        const totalAmount = unitPrice * quantity;
        
        document.getElementById('totalAmount').textContent = '¥' + totalAmount.toFixed(2);
    }
    
    // 表单验证
    document.getElementById('orderForm').addEventListener('submit', function(e) {
        const phone = document.getElementById('customer_phone').value;
        const phoneRegex = /^1[3-9]\d{9}$/;
        
        if (!phoneRegex.test(phone)) {
            e.preventDefault();
            showToast('请输入有效的11位手机号码', 'danger');
            return false;
        }
        
        // 显示提交中状态
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>提交中...';
        submitBtn.disabled = true;
    });
    
    // 手机号格式化
    document.getElementById('customer_phone').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 11);
    });
    
    // 实时更新金额
    document.getElementById('quantity').addEventListener('input', updateTotalAmount);
    
    // 初始化
    updateTotalAmount();
</script>

<style>
    @media print {
        .btn, nav, .footer, .breadcrumb {
            display: none !important;
        }
        
        .card {
            border: 1px solid #000 !important;
            box-shadow: none !important;
        }
    }
</style>
{% endblock %}